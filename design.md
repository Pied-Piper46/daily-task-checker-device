# IoTタスク管理デバイス 設計書

## 1. はじめに

### 1.1. プロジェクトの目的
日常のタスク管理を行う既存のダッシュボードおよびAPI (`Pied-Piper46/daily-task-checker`) と連携するIoTデバイスを開発する。このデバイスは、物理的なインターフェース（LEDマトリックス表示、タクトスイッチ入力）を通じて、特定のタスクの状態を視覚的に表示し、また簡単に更新できるようにすることを目的とする。

### 1.2. 設計書の目的
本設計書は、開発するIoTデバイスのハードウェア構成、ソフトウェア（ファームウェア）構成、および動作仕様を明確にし、開発プロセス全体の指針とすることを目的とする。

## 2. システム概要

### 2.1. システム構成図
```mermaid

[IoTデバイス (ESP32)] <--- Wi-Fi ---> [Wi-Fiルーター] <---> [インターネット]
^
| (HTTP/API)
v
[APIサーバー (FastAPI on Your Server)]
^ |
| | (SQLite)
| v
| [データベース]
|
[ダッシュボード (Web Browser)]

```


### 2.2. デバイス動作フロー
1.  **起動時:**
    *   ESP32システム初期化。
    *   Wi-Fiネットワークへの接続試行。
    *   NTPサーバーと時刻同期を行い、現在時刻を取得。
    *   APIサーバーから対象タスクの現在の状態を取得し、LEDマトリックスに表示。
2.  **タクトスイッチ押下時:**
    *   スイッチ入力のチャタリングを除去 (デバウンス処理)。
    *   管理対象タスクのローカル状態を反転させる（「済」⇔「未」）。
    *   LEDマトリックスの表示を新しい状態に更新。
    *   APIサーバーに対し、対象タスクの状態を更新するリクエストを送信。
3.  **定常時 (時刻監視):**
    *   内部クロックで時刻を監視。
    *   毎日0時0分になったことを検知した場合（0時リセット処理）:
        *   管理対象タスクのローカル状態を「未」に設定。
        *   LEDマトリックスの表示を「未」アイコンに更新。
        *   APIサーバーに対し、対象タスクの状態を「未」として更新するリクエストを送信。
4.  **エラー処理:**
    *   Wi-Fi接続失敗時やAPIサーバーとの通信エラー発生時は、エラー状態を検知。
    *   LEDマトリックスにエラーを示すアイコンを点滅表示。
    *   定期的に再接続・再試行処理を行う。

## 3. ハードウェア設計

### 3.1. 使用部品リスト
| No. | 部品名                                  | 仕様・型番例                                  | 数量 | 備考                                     |
| --- | --------------------------------------- | --------------------------------------------- | ---- | ---------------------------------------- |
| 1   | ESP32開発ボード                         | ESP32-DevKitC-VE (ESP32-WROOM-32E搭載)        | 1    | ブレッドボード対応幅                     |
| 2   | MAX7219駆動 8x8 LEDマトリックスモジュール | 汎用モジュール (Keyes, etc.)                  | 1    | 5ピン (VCC, GND, DIN, CS, CLK)           |
| 3   | タクトスイッチ                            | 6x6mm 4ピン ブレッドボード用                  | 1    |                                          |
| 4   | 抵抗器 (オプション)                     | 10kΩ                                          | 1    | タクトスイッチのプルアップ/ダウン用 (ESP32内蔵プルアップ使用時は不要) |
| 5   | ブレッドボード                            | MB-102など標準サイズ                          | 1    |                                          |
| 6   | ジャンパーワイヤー                        | オス-オス 各種長さ                            | 数本 |                                          |
| 7   | USBケーブル                             | Micro USB (ESP32電源供給・書き込み用)         | 1    |                                          |

### 3.2. 回路図 (ピン接続)
*   **ESP32 と MAX7219 LEDマトリックスモジュール:**
    *   MAX7219 VCC → ESP32 5V (または3.3V ※モジュール仕様確認)
    *   MAX7219 GND → ESP32 GND
    *   MAX7219 DIN (Data In) → ESP32 GPIO23 (HSPI MOSI推奨)
    *   MAX7219 CS (Chip Select) → ESP32 GPIO5 (HSPI SS推奨)
    *   MAX7219 CLK (Clock) → ESP32 GPIO18 (HSPI SCK推奨)
*   **ESP32 と タクトスイッチ:**
    *   タクトスイッチ 端子1 → ESP32 GPIO4 (任意、例として)
    *   タクトスイッチ 端子2 (端子1の対角) → ESP32 GND
    *(ESP32側のGPIO4は `INPUT_PULLUP` モードで使用)*
*   **電源:**
    *   ESP32開発ボードへUSBケーブル経由で電源供給。

## 4. ソフトウェア設計 (ファームウェア: ESP32)

### 4.1. 開発環境・言語
*   **開発環境:** Arduino IDE または PlatformIO with VSCode
*   **言語:** C/C++ (Arduino Framework)

### 4.2. 使用ライブラリ (予定)
*   `WiFi.h`: Wi-Fi接続管理
*   `HTTPClient.h`: HTTPリクエストの送受信 (HTTPSの場合は `WiFiClientSecure.h` も)
*   `ArduinoJson.h`: JSONデータの生成と解析
*   `LedControl.h` または `Adafruit_GFX.h` + `Adafruit_MAX7219.h`: MAX7219 LEDマトリックス制御
*   `NTPClient.h` (またはESP32標準のSNTP機能): NTPサーバーとの時刻同期
*   `Preferences.h`: (オプション) 設定値の不揮発メモリ保存

### 4.3. 主要機能モジュール
*   **`ConfigManager` (設定管理):**
    *   対象タスクID: ファームウェアにハードコーディング (`const char* TARGET_TASK_ID = "1";`)。
    *   APIサーバーベースURL: 開発用 (`http://<PCのローカルIP>:3000`) と公開用 (`https://daily-task-checker.vercel.app/`) を定義し、切り替え可能にする。
    *   Wi-Fi SSID/パスワード: ファームウェアにハードコーディング。
*   **`WiFiConnector` (Wi-Fi接続管理)**
*   **`TimeSyncer` (時刻同期・管理)**
*   **`SwitchInput` (スイッチ入力処理):** デバウンス処理を含む。
*   **`DisplayController` (LED表示制御):** 「済」「未」「エラー」アイコン表示 (エラー時は点滅)。
*   **`ApiClient` (API通信処理):** 起動時の状態取得(GET)、状態更新(PUT)。
*   **`TaskLogic` (タスク状態管理とメインロジック):** 状態の保持、イベント処理、各モジュールへの指示。

### 4.4. LEDマトリックス アイコン定義 (8x8ピクセル)
*   **「済」アイコン (例: チェックマーク):**
    ```
    //  B00000000, B00000010, B00000110, B01001100, B01101100, B00110000, B00000000, B00000000
    ```
*   **「未」アイコン (例: バツ印):**
    ```
    //  B01000010, B00100100, B00011000, B00011000, B00100100, B01000010, B00000000, B00000000
    ```
*   **エラーアイコン (例: 'X' 点滅):**
    ```
    //  B10000001, B01000010, B00100100, B00011000, B00011000, B00100100, B01000010, B10000001
    ```

### 4.5. 状態遷移 (概要)
起動 → Wi-Fi接続 → NTP同期 → API初期状態取得 → 通常動作 (表示・スイッチ待機)
    → スイッチ操作時: 状態変更 → API更新 → 表示更新
    → 0時: 状態リセット → API更新 → 表示更新
    → エラー発生時: エラー表示 → リトライ

## 5. 通信仕様 (デバイス ⇔ APIサーバー)

### 5.1. プロトコル
HTTP/1.1 (公開APIはHTTPSのため、最終的にはESP32もHTTPS対応が必要)

### 5.2. データ形式
JSON (application/json)

### 5.3. エンドポイント
*   **タスク状態更新:** `PUT {apiBaseUrl}/tasks/{targetTaskId}`
    *   ボディ: `{"completed": true/false}`
*   **タスク初期状態取得:** `GET {apiBaseUrl}/tasks/{targetTaskId}`

### 5.4. 認証
当面は認証なし。

## 6. UI/UX設計

### 6.1. LEDマトリックス表示
定義済みアイコンでタスク状態、「済」「未」「エラー」を明確に表示。エラー時は点滅。

### 6.2. タクトスイッチ操作
押下でタスク状態をトグル。

## 7. テスト計画
ハードウェアテスト、ファームウェア単体テスト、結合テスト、システムテストを段階的に実施。

## 8. 設計に関する決定事項

*   **対象タスクID:** ファームウェアにハードコーディング。
*   **APIサーバーURL:** 開発用(HTTP)と公開用(HTTPS)を切り替え可能に。開発時はPCのローカルIPを指定。
*   **API認証:** 現状なし。
*   **起動時初期状態取得:** 実装する。
*   **エラー表示:** LEDマトリックスでエラーアイコンを点滅。
*   **Wi-Fi設定:** ファームウェアにハードコーディング。

## 9. 今後の拡張性・課題 (参考)
*   HTTPS通信対応 (必須)
*   WiFiManager等によるWi-Fi設定の動的化
*   複数タスク対応
*   セキュリティ強化
*   省電力化
*   OTAファームウェア更新